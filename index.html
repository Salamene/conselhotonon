const PLANILHA_ID = "1QOwNnUCq_iBnQSgyJDBHh8lev7SAYnZciJNggcGktEM";

/**
 * Serve o HTML quando acessado diretamente
 */
function doGet(e) {
  // Se for uma requisi√ß√£o de API
  if (e.parameter && e.parameter.action) {
    return handleApiRequest(e);
  }
  
  // Sen√£o, servir o HTML normalmente
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Conselho Armelindo Tonon')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * Fun√ß√£o para receber dados via POST
 */
function doPost(e) {
  try {
    const dados = JSON.parse(e.postData.contents);
    
    if (dados.acao === 'salvarRegistro') {
      const resultado = salvarRegistro(dados);
      return ContentService.createTextOutput(JSON.stringify(resultado))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: 'A√ß√£o n√£o reconhecida'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Manipula requisi√ß√µes da API
 */
function handleApiRequest(e) {
  const action = e.parameter.action;
  
  try {
    switch(action) {
      case 'carregarDadosIniciais':
        return carregarDadosIniciais();
      case 'getProfessoresPorTurma':
        const professores = getProfessoresPorTurma(e.parameter.turma);
        return ContentService.createTextOutput(JSON.stringify(professores))
          .setMimeType(ContentService.MimeType.JSON);
      case 'getAlunosPorTurma':
        const alunos = getAlunosPorTurma(e.parameter.turma);
        return ContentService.createTextOutput(JSON.stringify(alunos))
          .setMimeType(ContentService.MimeType.JSON);
      case 'getTodosRegistros':
        const registros = getTodosRegistros();
        return ContentService.createTextOutput(JSON.stringify(registros))
          .setMimeType(ContentService.MimeType.JSON);
      case 'getTurmas':
        const turmas = getTurmas();
        return ContentService.createTextOutput(JSON.stringify(turmas))
          .setMimeType(ContentService.MimeType.JSON);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          success: false,
          error: 'A√ß√£o n√£o reconhecida: ' + action
        })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Inicializa a planilha com todas as abas necess√°rias
 */
function inicializarPlanilha() {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    
    // Configura√ß√£o das abas
    const abasConfig = [
      {
        nome: 'Registros',
        cabecalhos: ['Data', 'Professor', 'Mat√©ria', 'Turma', 'Aluno', 'Observa√ß√µes', 'Comportamento', 'Status'],
        cor: '#1976D2'
      },
      {
        nome: 'Dados Professores',
        cabecalhos: ['Turma', 'Professor', 'Mat√©ria', 'Email', 'Ativo'],
        cor: '#388E3C'
      },
      {
        nome: 'Lista de Alunos',
        cabecalhos: ['Aluno', 'Turma', 'Data Nascimento', 'Respons√°vel', 'Telefone'],
        cor: '#7B1FA2'
      },
      {
        nome: 'Turmas',
        cabecalhos: ['Turma', 'Ano', 'Turno', 'Professor Respons√°vel', 'Total Alunos'],
        cor: '#D32F2F'
      }
    ];

    abasConfig.forEach(config => {
      let aba = ss.getSheetByName(config.nome);
      
      if (!aba) {
        aba = ss.insertSheet(config.nome);
        Logger.log(`‚úÖ Aba ${config.nome} criada`);
      }
      
      // Configurar cabe√ßalhos
      const rangeCabecalho = aba.getRange(1, 1, 1, config.cabecalhos.length);
      rangeCabecalho.setValues([config.cabecalhos]);
      rangeCabecalho.setBackground(config.cor)
                   .setFontColor('white')
                   .setFontWeight('bold')
                   .setHorizontalAlignment('center');
      
      // Congelar cabe√ßalho
      aba.setFrozenRows(1);
      
      // Ajustar colunas
      aba.autoResizeColumns(1, config.cabecalhos.length);
    });

    // Adicionar dados de exemplo
    adicionarDadosExemplo();
    
    SpreadsheetApp.flush();
    Logger.log('üéâ Planilha inicializada com sucesso');
    
    return {
      success: true,
      message: 'Sistema configurado com sucesso!'
    };
    
  } catch (error) {
    Logger.log(`‚ùå Erro ao inicializar: ${error.message}`);
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Adiciona dados de exemplo
 */
function adicionarDadosExemplo() {
  const ss = SpreadsheetApp.openById(PLANILHA_ID);
  
  // Dados de professores
  const abaProfessores = ss.getSheetByName('Dados Professores');
  if (abaProfessores.getLastRow() < 2) {
    const professores = [
      ['6¬∫A', 'Ana Silva', 'Matem√°tica', 'ana.silva@escola.com', 'Sim'],
      ['6¬∫A', 'Carlos Oliveira', 'Portugu√™s', 'carlos.oliveira@escola.com', 'Sim'],
      ['7¬∫B', 'Mariana Santos', 'Ci√™ncias', 'mariana.santos@escola.com', 'Sim'],
      ['7¬∫B', 'Roberto Lima', 'Hist√≥ria', 'roberto.lima@escola.com', 'Sim'],
      ['8¬∫C', 'Juliana Costa', 'Geografia', 'juliana.costa@escola.com', 'Sim'],
      ['9¬∫D', 'Paulo Mendes', 'Educa√ß√£o F√≠sica', 'paulo.mendes@escola.com', 'Sim']
    ];
    abaProfessores.getRange(2, 1, professores.length, 5).setValues(professores);
  }
  
  // Dados de alunos
  const abaAlunos = ss.getSheetByName('Lista de Alunos');
  if (abaAlunos.getLastRow() < 2) {
    const alunos = [
      ['Jo√£o Pedro Almeida', '6¬∫A', '15/03/2010', 'Maria Almeida', '(11) 99999-9999'],
      ['Maria Eduarda Silva', '6¬∫A', '20/05/2010', 'Jos√© Silva', '(11) 88888-8888'],
      ['Pedro Henrique Oliveira', '7¬∫B', '10/08/2009', 'Ana Oliveira', '(11) 77777-7777'],
      ['Ana Carolina Santos', '7¬∫B', '25/11/2009', 'Carlos Santos', '(11) 66666-6666'],
      ['Lucas Gabriel Costa', '8¬∫C', '30/01/2009', 'Fernanda Costa', '(11) 55555-5555'],
      ['Juliana Pereira Lima', '9¬∫D', '12/07/2008', 'Roberto Lima', '(11) 44444-4444']
    ];
    abaAlunos.getRange(2, 1, alunos.length, 5).setValues(alunos);
  }
  
  // Dados de turmas
  const abaTurmas = ss.getSheetByName('Turmas');
  if (abaTurmas.getLastRow() < 2) {
    const turmas = [
      ['6¬∫A', '2024', 'Manh√£', 'Ana Silva', '25'],
      ['7¬∫B', '2024', 'Tarde', 'Roberto Lima', '22'],
      ['8¬∫C', '2024', 'Manh√£', 'Juliana Costa', '28'],
      ['9¬∫D', '2024', 'Tarde', 'Paulo Mendes', '24']
    ];
    abaTurmas.getRange(2, 1, turmas.length, 5).setValues(turmas);
  }
}

/**
 * Busca dados para o dashboard
 */
function getDadosDashboard() {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    
    const abaRegistros = ss.getSheetByName('Registros');
    const abaProfessores = ss.getSheetByName('Dados Professores');
    const abaAlunos = ss.getSheetByName('Lista de Alunos');
    const abaTurmas = ss.getSheetByName('Turmas');
    
    const totalRegistros = Math.max(abaRegistros.getLastRow() - 1, 0);
    const totalProfessores = Math.max(abaProfessores.getLastRow() - 1, 0);
    const totalAlunos = Math.max(abaAlunos.getLastRow() - 1, 0);
    const totalTurmas = Math.max(abaTurmas.getLastRow() - 1, 0);
    
    return {
      success: true,
      data: {
        estatisticas: {
          totalRegistros,
          totalProfessores,
          totalAlunos,
          totalTurmas
        }
      }
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Busca professores por turma
 */
function getProfessoresPorTurma(turma) {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const aba = ss.getSheetByName('Dados Professores');
    const lastRow = aba.getLastRow();
    
    if (lastRow < 2) {
      return { success: true, data: [] };
    }
    
    const dados = aba.getRange(2, 1, lastRow - 1, 5).getValues();
    
    const professores = dados
      .filter(row => row[0] === turma && row[4] === 'Sim')
      .map(row => ({
        professor: row[1],
        materia: row[2],
        email: row[3]
      }));
    
    return {
      success: true,
      data: professores
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Busca alunos por turma
 */
function getAlunosPorTurma(turma) {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const aba = ss.getSheetByName('Lista de Alunos');
    const lastRow = aba.getLastRow();
    
    if (lastRow < 2) {
      return { success: true, data: [] };
    }
    
    const dados = aba.getRange(2, 1, lastRow - 1, 2).getValues();
    
    const alunos = dados
      .filter(row => row[1] === turma)
      .map(row => row[0]);
    
    return {
      success: true,
      data: alunos
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Salva um novo registro
 */
function salvarRegistro(dados) {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const aba = ss.getSheetByName('Registros');
    
    const novoRegistro = [
      new Date(),
      dados.professor,
      dados.materia,
      dados.turma,
      dados.aluno,
      dados.observacoes,
      dados.comportamento,
      'Pendente'
    ];
    
    aba.appendRow(novoRegistro);
    
    // Formatar data
    const ultimaLinha = aba.getLastRow();
    aba.getRange(ultimaLinha, 1).setNumberFormat('dd/MM/yyyy HH:mm');
    
    return {
      success: true,
      message: '‚úÖ Registro salvo com sucesso!'
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Busca todos os registros
 */
function getTodosRegistros() {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const aba = ss.getSheetByName('Registros');
    const lastRow = aba.getLastRow();
    
    if (lastRow < 2) {
      return { success: true, data: [] };
    }
    
    const dados = aba.getRange(2, 1, lastRow - 1, 8).getValues();
    
    const registros = dados.map(row => ({
      data: row[0],
      professor: row[1],
      materia: row[2],
      turma: row[3],
      aluno: row[4],
      observacoes: row[5],
      comportamento: row[6],
      status: row[7]
    }));
    
    return {
      success: true,
      data: registros.reverse() // Mais recentes primeiro
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Busca todas as turmas dispon√≠veis
 */
function getTurmas() {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const aba = ss.getSheetByName('Turmas');
    const lastRow = aba.getLastRow();
    
    if (lastRow < 2) {
      return { success: true, data: ['6¬∫A', '7¬∫B', '8¬∫C', '9¬∫D'] };
    }
    
    const dados = aba.getRange(2, 1, lastRow - 1, 1).getValues();
    const turmas = dados.map(row => row[0]);
    
    return {
      success: true,
      data: turmas
    };
    
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}

/**
 * Fun√ß√£o especial para carregar dados iniciais
 */
function carregarDadosIniciais() {
  try {
    const dashboard = getDadosDashboard();
    const turmas = getTurmas();
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      data: {
        turmas: turmas.data,
        estatisticas: dashboard.data.estatisticas
      }
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Testa a conex√£o com a planilha
 */
function testarConexao() {
  try {
    const ss = SpreadsheetApp.openById(PLANILHA_ID);
    const abas = ss.getSheets().map(sheet => sheet.getName());
    
    return {
      success: true,
      message: '‚úÖ Conex√£o estabelecida com sucesso!',
      abas: abas
    };
    
  } catch (error) {
    return {
      success: false,
      error: '‚ùå Erro na conex√£o: ' + error.message
    };
  }
}
