<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conselho Armelindo Tonon</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }

    .logo i {
      font-size: 2.5rem;
      color: #4CAF50;
    }

    h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #7f8c8d;
      font-size: 1.2rem;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .card i {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .card.registros i { color: #e74c3c; }
    .card.professores i { color: #3498db; }
    .card.alunos i { color: #2ecc71; }
    .card.turmas i { color: #9b59b6; }

    .card h3 {
      font-size: 2rem;
      margin-bottom: 5px;
      color: #2c3e50;
    }

    .card p {
      color: #7f8c8d;
      font-weight: 500;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h2 i {
      color: #4CAF50;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    select, textarea, input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    select:focus, textarea:focus, input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    .btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .registros-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .registro-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #4CAF50;
    }

    .registro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .registro-professor {
      font-weight: 600;
      color: #2c3e50;
    }

    .registro-data {
      color: #7f8c8d;
      font-size: 0.9rem;
    }

    .registro-aluno {
      color: #e74c3c;
      font-weight: 500;
    }

    .registro-observacoes {
      color: #555;
      margin-top: 5px;
      font-size: 0.95rem;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 5px;
    }

    .status.pendente {
      background: #fff3cd;
      color: #856404;
    }

    .status.concluido {
      background: #d1edff;
      color: #0c5460;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .alert {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    .alert.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .nav-tab {
      padding: 12px 24px;
      background: #ecf0f1;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .nav-tab.active {
      background: #4CAF50;
      color: white;
    }

    /* Estilos específicos para correções */
    .materia-input {
      cursor: text !important;
      background-color: white !important;
    }
    
    .materia-input:focus {
      border-color: #4CAF50 !important;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.3) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <i class="fas fa-school"></i>
        <div>
          <h1>Conselho Armelindo Tonon</h1>
          <p class="subtitle">Sistema de Gestão Educacional</p>
        </div>
      </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="dashboard">
      <div class="card registros">
        <i class="fas fa-clipboard-list"></i>
        <h3 id="totalRegistros">0</h3>
        <p>Registros</p>
      </div>
      <div class="card professores">
        <i class="fas fa-chalkboard-teacher"></i>
        <h3 id="totalProfessores">0</h3>
        <p>Professores</p>
      </div>
      <div class="card alunos">
        <i class="fas fa-user-graduate"></i>
        <h3 id="totalAlunos">0</h3>
        <p>Alunos</p>
      </div>
      <div class="card turmas">
        <i class="fas fa-users"></i>
        <h3 id="totalTurmas">0</h3>
        <p>Turmas</p>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showTab(\'novo-registro\', this)">
        <i class="fas fa-plus"></i> Novo Registro
      </button>
      <button class="nav-tab" onclick="showTab(\'historico\', this)">       <i class="fas fa-history"></i> Histórico
      </button>
    </div>

    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Novo Registro -->
      <div class="section" id="novo-registro-tab">
        <h2><i class="fas fa-edit"></i> Novo Registro do Conselho</h2>
        
        <div id="alert"></div>
        
        <form id="registroForm">
          <div class="form-group">
            <label for="turma"><i class="fas fa-users"></i> Turma</label>
            <select id="turma" name="turma" required onchange="carregarProfessoresEAlunos()">
              <option value="">Selecione a turma</option>
            </select>
          </div>

          <div class="form-group">
            <label for="professor"><i class="fas fa-chalkboard-teacher"></i> Professor</label>
            <select id="professor" name="professor" required>
              <option value="">Selecione o professor</option>
            </select>
          </div>

          <div class="form-group">
            <label for="materia"><i class="fas fa-book"></i> Matéria</label>
            <input type="text" id="materia" name="materia" class="materia-input" required placeholder="Digite a matéria ou selecione um professor para preenchimento automático">
          </div>

          <div class="form-group">
            <label for="aluno"><i class="fas fa-user-graduate"></i> Aluno</label>
            <select id="aluno" name="aluno" required>
              <option value="">Selecione o aluno</option>
            </select>
          </div>

          <div class="form-group">
            <label for="observacoes"><i class="fas fa-sticky-note"></i> Observações</label>
            <textarea id="observacoes" name="observacoes" placeholder="Digite as observações sobre o aluno..." required></textarea>
          </div>

          <div class="form-group">
            <label for="comportamento"><i class="fas fa-chart-line"></i> Comportamento</label>
            <textarea id="comportamento" name="comportamento" placeholder="Observações sobre o comportamento em sala..." required></textarea>
          </div>

          <button type="submit" class="btn" id="btnEnviar">
            <i class="fas fa-paper-plane"></i> Enviar Registro
          </button>
        </form>
      </div>

      <!-- Histórico -->
      <div class="section" id="historico-tab" style="display: none;">
        <h2><i class="fas fa-history"></i> Histórico de Registros</h2>
        <div class="registros-list" id="listaRegistros">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando registros...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Loading Overlay -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 9999;
  ">
    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 15px;"></i>
    <p style="font-size: 1.2rem;">Carregando...</p>
  </div>

  <script>
    // Variáveis globais
    let dadosDashboard = {};

    // Inicialização
    window.onload = function() {
      mostrarLoading(true); // Exibir loading ao iniciar
      carregarDadosIniciais();
    };

    // Mostrar/ocultar abas
    function showTab(tabName, element) {
      // Esconder todas as tabs
      document.getElementById('novo-registro-tab').style.display = 'none';
      document.getElementById('historico-tab').style.display = 'none';
      
      // Remover classe active de todos os botões
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Mostrar tab selecionada
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      // Adicionar classe active ao botão clicado      if (element) {
        element.classList.add(\'active\');
      }      
      // Recarregar dados se for a tab de histórico
      if (tabName === 'historico') {
        carregarHistorico();
      }
    }

    // Carregar dados iniciais
    function carregarDadosIniciais() {
      mostrarLoading(true);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            dadosDashboard = result.data;
            atualizarDashboard();
            preencherTurmas();
            mostrarAlert('Sistema carregado com sucesso!', 'success');
          } else {
            mostrarAlert('Erro: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          console.error(\'Erro ao carregar dados:\', error);
          mostrarAlert(\'Erro de conexão. Usando dados de exemplo...\', \'error\');
          carregarDadosFallback();
        })
        .withCompleteHandler(function() {
          mostrarLoading(false);
        })
        .carregarDadosIniciais();
    }

    // Fallback caso a API falhe
    function carregarDadosFallback() {
      dadosDashboard = {
        turmas: [\'6ºA\', \'7ºB\', \'8ºC\', \'9ºD\'],
        estatisticas: {
          totalRegistros: 0,
          totalProfessores: 6,
          totalAlunos: 6,
          totalTurmas: 4
        }
      };
      atualizarDashboard();
      preencherTurmas();
      mostrarLoading(false); // Desativar loading após fallback
    }

    // Preencher dropdown de turmas
    function preencherTurmas() {
      const selectTurma = document.getElementById('turma');
      selectTurma.innerHTML = '<option value="">Selecione a turma</option>';
      
      if (dadosDashboard.turmas && dadosDashboard.turmas.length > 0) {
        dadosDashboard.turmas.forEach(turma => {
          const option = document.createElement('option');
          option.value = turma;
          option.textContent = turma;
          selectTurma.appendChild(option);
        });
      }
    }

    // Atualizar estatísticas do dashboard
    function atualizarDashboard() {
      const stats = dadosDashboard.estatisticas;
      if (stats) {
        document.getElementById('totalRegistros').textContent = stats.totalRegistros || 0;
        document.getElementById('totalProfessores').textContent = stats.totalProfessores || 0;
        document.getElementById('totalAlunos').textContent = stats.totalAlunos || 0;
        document.getElementById('totalTurmas').textContent = stats.totalTurmas || 0;
      }
    }

    // Carregar professores e alunos baseado na turma - CORRIGIDO
    function carregarProfessoresEAlunos() {
      const turma = document.getElementById('turma').value;
      
      if (!turma) {
        // Limpar campos se não há turma selecionada
        document.getElementById('professor').innerHTML = '<option value="">Selecione o professor</option>';
        document.getElementById('materia').value = '';
        document.getElementById('aluno').innerHTML = '<option value="">Selecione o aluno</option>';
        return;
      }

      // Carregar professores
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data.length > 0) {
            const select = document.getElementById('professor');
            select.innerHTML = '<option value="">Selecione o professor</option>';
            
            result.data.forEach(prof => {
              const option = document.createElement('option');
              option.value = prof.professor;
              option.textContent = `${prof.professor} - ${prof.materia}`;
              
              // Armazenar a matéria como data attribute para preenchimento automático
              option.setAttribute('data-materia', prof.materia);
              select.appendChild(option);
            });
            
            // Adicionar evento para preencher matéria automaticamente
            select.addEventListener('change', function() {
              const selectedOption = this.options[this.selectedIndex];
              if (selectedOption && selectedOption.value) {
                document.getElementById('materia').value = selectedOption.getAttribute('data-materia') || '';
              } else {
                document.getElementById('materia').value = '';
              }
            });
            
          } else {
            document.getElementById('professor').innerHTML = '<option value="">Nenhum professor encontrado</option>';
            document.getElementById('materia').value = '';
          }
        })
        .withFailureHandler(function(error) {
          console.error(\'Erro ao carregar professores:\', error);
          document.getElementById(\'professor\').innerHTML = \'<option value="">Erro ao carregar</option>\';
        })
        .withCompleteHandler(function() {
          mostrarLoading(false);
        })
        .getProfessoresPorTurma(turma);

      // Carregar alunos
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data.length > 0) {
            const select = document.getElementById('aluno');
            select.innerHTML = '<option value="">Selecione o aluno</option>';
            result.data.forEach(aluno => {
              const option = document.createElement('option');
              option.value = aluno;
              option.textContent = aluno;
              select.appendChild(option);
            });
          } else {
            document.getElementById('aluno').innerHTML = '<option value="">Nenhum aluno encontrado</option>';
          }
        })
        .withFailureHandler(function(error) {
          console.error(\'Erro ao carregar alunos:\', error);
          document.getElementById(\'aluno\').innerHTML = \'<option value="">Erro ao carregar</option>\';
        })
        .withCompleteHandler(function() {
          mostrarLoading(false);
        })
        .getAlunosPorTurma(turma);
    }

    // Enviar formulário de registro
    document.getElementById('registroForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const btnEnviar = document.getElementById('btnEnviar');
      const btnTextoOriginal = btnEnviar.innerHTML;
      
      // Desabilitar botão e mostrar loading
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      const formData = new FormData(this);
      const dados = {
        acao: 'salvarRegistro',
        turma: formData.get('turma'),
        professor: formData.get('professor'),
        materia: formData.get('materia'),
        aluno: formData.get('aluno'),
        observacoes: formData.get('observacoes'),
        comportamento: formData.get('comportamento')
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            mostrarAlert(result.message, 'success');
            document.getElementById('registroForm').reset();
            carregarDadosIniciais(); // Atualizar estatísticas
          } else {
            mostrarAlert('Erro: ' + result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          mostrarAlert(\'Erro ao enviar: \' + error.message, \'error\');
        })
        .withCompleteHandler(function() {
          btnEnviar.disabled = false;
          btnEnviar.innerHTML = btnTextoOriginal;
        })
        .salvarRegistro(dados);
    });

    // Carregar histórico de registros
    function carregarHistorico() {
      const container = document.getElementById('listaRegistros');
      container.innerHTML = `
        <div class="loading">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando registros...</p>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            exibirRegistros(result.data);
          } else {
            container.innerHTML = '<p class="error">Erro ao carregar registros: ' + result.error + '</p>';
          }
        })
        .withFailureHandler(function(error) {
          container.innerHTML = `<p class="error">Erro de conexão: ${error.message}</p>`;
        })
        .withCompleteHandler(function() {
          mostrarLoading(false);
        })
        .getTodosRegistros();
    }

    // Exibir registros na lista
    function exibirRegistros(registros) {
      const container = document.getElementById('listaRegistros');
      
      if (!registros || registros.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Nenhum registro encontrado</p>';
        return;
      }

      container.innerHTML = registros.map(reg => `
        <div class="registro-item">
          <div class="registro-header">
            <span class="registro-professor">${reg.professor || 'N/A'}</span>
            <span class="registro-data">${formatarData(reg.data)}</span>
          </div>
          <div class="registro-aluno">
            <i class="fas fa-user-graduate"></i> ${reg.aluno || 'N/A'} - ${reg.turma || 'N/A'}
          </div>
          <div class="registro-observacoes">
            <strong>Observações:</strong> ${reg.observacoes || 'Nenhuma'}
          </div>
          <div class="registro-observacoes">
            <strong>Comportamento:</strong> ${reg.comportamento || 'Nenhuma'}
          </div>
          <span class="status ${(reg.status || 'pendente').toLowerCase()}">${reg.status || 'Pendente'}</span>
        </div>
      `).join('');
    }

    // Mostrar alertas
    function mostrarAlert(mensagem, tipo) {
      const alertDiv = document.getElementById('alert');
      alertDiv.innerHTML = `
        <div class="alert ${tipo}">
          <i class="fas fa-${tipo === 'success' ? 'check' : 'exclamation'}-circle"></i>
          ${mensagem}
        </div>
      `;
      
      setTimeout(() => {
        alertDiv.innerHTML = '';
      }, 5000);
    }

    // Mostrar/ocultar loading
    function mostrarLoading(mostrar) {
      const btnEnviar = document.getElementById(\'btnEnviar\');
      const loadingOverlay = document.getElementById(\'loadingOverlay\');

      if (btnEnviar) {
        btnEnviar.disabled = mostrar;
        if (mostrar) {
          btnEnviar.innerHTML = \'<i class="fas fa-spinner fa-spin"></i> Carregando...\';
        } else {
          btnEnviar.innerHTML = \'<i class="fas fa-paper-plane"></i> Enviar Registro\';
        }
      }

      if (loadingOverlay) {
        loadingOverlay.style.display = mostrar ? \'flex\' : \'none\';
      }
    }

    // Formatar data
    function formatarData(dataString) {
      try {
        if (!dataString) return 'Data não disponível';
        const data = new Date(dataString);
        return isNaN(data.getTime()) ? dataString : 
          data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR');
      } catch (e) {
        return dataString;
      }
    }
  </script>
</body>
</html>
